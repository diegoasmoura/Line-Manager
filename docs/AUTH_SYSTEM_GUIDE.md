# üîê Guia T√©cnico - Sistema de Autentica√ß√£o Farol

## Vis√£o Geral da Arquitetura

O sistema de autentica√ß√£o do Farol foi projetado para ser seguro, escal√°vel e f√°cil de manter. Utiliza banco de dados Oracle para persist√™ncia, bcrypt para hash de senhas e Streamlit para interface de usu√°rio.

### Componentes Principais

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Frontend      ‚îÇ    ‚îÇ   Backend       ‚îÇ    ‚îÇ   Database      ‚îÇ
‚îÇ   (Streamlit)   ‚îÇ    ‚îÇ   (Python)      ‚îÇ    ‚îÇ   (Oracle)      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚Ä¢ login.py      ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ ‚Ä¢ auth_db.py    ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ ‚Ä¢ F_CON_USERS   ‚îÇ
‚îÇ ‚Ä¢ setup.py      ‚îÇ    ‚îÇ ‚Ä¢ bcrypt        ‚îÇ    ‚îÇ ‚Ä¢ √çndices       ‚îÇ
‚îÇ ‚Ä¢ app.py        ‚îÇ    ‚îÇ ‚Ä¢ SQLAlchemy    ‚îÇ    ‚îÇ ‚Ä¢ Constraints   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Fluxo de Autentica√ß√£o

### 1. Login do Usu√°rio
```mermaid
graph TD
    A[Usu√°rio insere credenciais] --> B[login.py: show_login_form]
    B --> C[auth_db.py: authenticate_user]
    C --> D[Busca usu√°rio no Oracle]
    D --> E{Usu√°rio existe?}
    E -->|N√£o| F[Retorna None]
    E -->|Sim| G{Usu√°rio ativo?}
    G -->|N√£o| F
    G -->|Sim| H[Verifica senha com bcrypt]
    H --> I{Senha correta?}
    I -->|N√£o| F
    I -->|Sim| J[Atualiza LAST_LOGIN]
    J --> K[Retorna dados do usu√°rio]
    K --> L[Armazena em session_state]
    L --> M[Redireciona para app principal]
```

### 2. Verifica√ß√£o de Permiss√µes
```mermaid
graph TD
    A[Usu√°rio tenta acessar funcionalidade] --> B[has_access_level]
    B --> C[Obt√©m ACCESS_LEVEL do session_state]
    C --> D[Compara com n√≠vel requerido]
    D --> E{Usu√°rio tem permiss√£o?}
    E -->|Sim| F[Permite acesso]
    E -->|N√£o| G[Bloqueia acesso + mensagem]
```

## Estrutura de Dados

### Session State
O sistema armazena as seguintes informa√ß√µes na sess√£o do Streamlit:

```python
st.session_state = {
    'current_user': 'username',           # Username do usu√°rio logado
    'user_data': {                        # Dados completos do usu√°rio
        'USER_ID': 1,
        'USERNAME': 'admin',
        'EMAIL': 'admin@farol.com',
        'FULL_NAME': 'Administrador',
        'BUSINESS_UNIT': None,
        'ACCESS_LEVEL': 'ADMIN',
        'IS_ACTIVE': 1,
        'PASSWORD_RESET_REQUIRED': 0
    },
    'login_time': datetime.now(),         # Timestamp do login
    'force_password_change': False        # Flag para troca obrigat√≥ria
}
```

### Tabela F_CON_USERS
```sql
CREATE TABLE LogTransp.F_CON_USERS (
  USER_ID           NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  USERNAME          VARCHAR2(150 CHAR) NOT NULL UNIQUE,
  EMAIL             VARCHAR2(255 CHAR) NOT NULL UNIQUE,
  PASSWORD_HASH     VARCHAR2(255 CHAR) NOT NULL,  -- bcrypt hash (60 chars)
  FULL_NAME         VARCHAR2(255 CHAR) NOT NULL,
  BUSINESS_UNIT     VARCHAR2(50 CHAR),            -- NULL = acesso a todas
  ACCESS_LEVEL      VARCHAR2(20 CHAR) NOT NULL,   -- VIEW/EDIT/ADMIN
  IS_ACTIVE         NUMBER(1) DEFAULT 1 NOT NULL, -- 1=ativo, 0=inativo
  CREATED_AT        TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  CREATED_BY        VARCHAR2(150 CHAR),
  UPDATED_AT        TIMESTAMP(6),
  UPDATED_BY        VARCHAR2(150 CHAR),
  LAST_LOGIN        TIMESTAMP(6),
  PASSWORD_RESET_REQUIRED NUMBER(1) DEFAULT 0     -- 1=deve trocar senha
);
```

## M√≥dulos e Fun√ß√µes

### auth/login.py
**Prop√≥sito**: Interface de login e fun√ß√µes de controle de acesso

**Fun√ß√µes principais**:
- `show_login_form()`: Exibe formul√°rio de login
- `authenticate_user()`: Chama autentica√ß√£o do banco
- `has_access_level(required_level)`: Verifica permiss√µes
- `get_user_info()`: Retorna informa√ß√µes do usu√°rio
- `logout()`: Limpa sess√£o

**Exemplo de uso**:
```python
from auth.login import has_access_level, get_current_user

# Verificar se usu√°rio pode editar
if has_access_level('EDIT'):
    if st.button("Salvar"):
        # L√≥gica de salvamento
else:
    st.warning("Acesso negado. N√≠vel: Visualiza√ß√£o")
```

### auth/auth_db.py
**Prop√≥sito**: Opera√ß√µes de banco de dados para autentica√ß√£o

**Fun√ß√µes principais**:
- `hash_password(password)`: Gera hash bcrypt
- `verify_password(password, hash)`: Verifica senha
- `authenticate_user(username, password)`: Autentica usu√°rio
- `create_user()`: Cria novo usu√°rio (ADMIN)
- `update_user()`: Atualiza usu√°rio (ADMIN)
- `reset_user_password()`: Reseta senha (ADMIN)
- `list_users()`: Lista todos usu√°rios (ADMIN)

**Exemplo de uso**:
```python
from auth.auth_db import authenticate_user, create_user

# Autenticar usu√°rio
user_data = authenticate_user("admin", "Admin@2025")
if user_data:
    print(f"Login bem-sucedido: {user_data['FULL_NAME']}")

# Criar usu√°rio (apenas ADMIN)
success = create_user(
    username="novo.usuario",
    email="usuario@empresa.com",
    password="senha123",
    full_name="Novo Usu√°rio",
    business_unit="COTTON",
    access_level="EDIT",
    created_by="admin"
)
```

## N√≠veis de Acesso

### Hierarquia
```
ADMIN (3) > EDIT (2) > VIEW (1)
```

### Implementa√ß√£o
```python
def has_access_level(required_level: str) -> bool:
    levels = {'VIEW': 1, 'EDIT': 2, 'ADMIN': 3}
    current_level = user_data.get('ACCESS_LEVEL', 'VIEW')
    return levels.get(current_level, 0) >= levels.get(required_level, 0)
```

### Aplica√ß√£o em M√≥dulos
```python
# Em shipments.py
if has_access_level('EDIT'):
    if st.button("‚úÖ Confirm Changes"):
        # L√≥gica de salvamento
else:
    st.warning("‚ö†Ô∏è Voc√™ n√£o tem permiss√£o para editar dados.")

# Em setup.py
if has_access_level('ADMIN'):
    tabs = st.tabs(["Credenciais", "Administra√ß√£o de Usu√°rios"])
else:
    tabs = st.tabs(["Credenciais"])
```

## Seguran√ßa

### Hash de Senhas
- **Algoritmo**: bcrypt
- **Rounds**: 12 (balance entre seguran√ßa e performance)
- **Tamanho**: 60 caracteres no banco
- **Salt**: Gerado automaticamente pelo bcrypt

```python
def hash_password(password: str) -> str:
    salt = bcrypt.gensalt(rounds=12)
    return bcrypt.hashpw(password.encode('utf-8'), salt).decode('utf-8')
```

### Valida√ß√µes
- **Username**: √önico, case-insensitive
- **Email**: √önico, case-insensitive
- **Senha**: M√≠nimo 6 caracteres
- **N√≠vel de acesso**: Apenas VIEW/EDIT/ADMIN
- **Status**: Apenas 0/1

### Prote√ß√£o contra SQL Injection
- Uso de SQLAlchemy com par√¢metros nomeados
- Valida√ß√£o de entrada em todas as fun√ß√µes
- Escape autom√°tico de caracteres especiais

## Administra√ß√£o de Usu√°rios

### Interface (setup.py)
A interface de administra√ß√£o est√° integrada ao m√≥dulo `setup.py` e s√≥ √© vis√≠vel para usu√°rios ADMIN.

**Funcionalidades**:
1. **Listar Usu√°rios**: Tabela com todos os usu√°rios e m√©tricas
2. **Criar Usu√°rio**: Formul√°rio com valida√ß√µes
3. **Editar Usu√°rio**: Modificar dados existentes
4. **Reset de Senha**: Alterar senha de qualquer usu√°rio

### Valida√ß√µes de Neg√≥cio
- Username √∫nico (verifica√ß√£o em tempo real)
- Email √∫nico (verifica√ß√£o em tempo real)
- Senha m√≠nima de 6 caracteres
- Confirma√ß√£o de senha no reset
- Username n√£o edit√°vel ap√≥s cria√ß√£o

## Scripts de Manuten√ß√£o

### Inicializa√ß√£o
```bash
python scripts/init_auth_system.py
```

**O que faz**:
1. Verifica se tabela `F_CON_USERS` existe
2. Cria tabela se n√£o existir
3. Cria usu√°rio admin inicial
4. Configura permiss√µes e √≠ndices

### Verifica√ß√£o de Integridade
```sql
-- Verificar usu√°rios ativos
SELECT USERNAME, FULL_NAME, ACCESS_LEVEL, LAST_LOGIN 
FROM LogTransp.F_CON_USERS 
WHERE IS_ACTIVE = 1;

-- Verificar usu√°rios com senha para trocar
SELECT USERNAME, FULL_NAME 
FROM LogTransp.F_CON_USERS 
WHERE PASSWORD_RESET_REQUIRED = 1;
```

## Extensibilidade

### Adicionar Novo N√≠vel de Acesso
1. **Banco de dados**: Adicionar constraint na tabela
2. **C√≥digo**: Atualizar dicion√°rio `levels` em `has_access_level()`
3. **Interface**: Adicionar op√ß√£o nos dropdowns
4. **Documenta√ß√£o**: Atualizar README e este guia

### Adicionar Nova Unidade de Neg√≥cio
1. **C√≥digo**: Atualizar fun√ß√£o `get_business_units()`
2. **Interface**: Adicionar op√ß√£o nos formul√°rios
3. **L√≥gica**: Implementar filtros por unidade se necess√°rio

### Integrar em Novo M√≥dulo
```python
# 1. Importar fun√ß√£o de verifica√ß√£o
from auth.login import has_access_level

# 2. Aplicar verifica√ß√£o antes de a√ß√µes sens√≠veis
if has_access_level('EDIT'):
    if st.button("A√ß√£o Sens√≠vel"):
        # L√≥gica da a√ß√£o
else:
    st.warning("Acesso negado. N√≠vel necess√°rio: Edi√ß√£o")
```

## Troubleshooting

### Problemas Comuns

**Erro: "Tabela F_CON_USERS n√£o existe"**
- Solu√ß√£o: Execute `python scripts/init_auth_system.py`

**Erro: "Usu√°rio n√£o encontrado"**
- Verifique se username est√° correto
- Confirme se usu√°rio est√° ativo
- Verifique conex√£o com banco

**Erro: "Senha incorreta"**
- Verifique se senha est√° correta
- Confirme se hash est√° sendo gerado corretamente
- Verifique se bcrypt est√° instalado

**Erro: "Acesso negado"**
- Verifique n√≠vel de acesso do usu√°rio
- Confirme se fun√ß√£o `has_access_level()` est√° sendo chamada corretamente
- Verifique se `user_data` est√° no session_state

### Logs e Debug
```python
# Habilitar debug no auth_db.py
import logging
logging.basicConfig(level=logging.DEBUG)

# Verificar dados do usu√°rio
print(f"User data: {st.session_state.get('user_data', {})}")
print(f"Access level: {st.session_state.get('user_data', {}).get('ACCESS_LEVEL')}")
```

## Boas Pr√°ticas para Desenvolvedores

### 1. Sempre Verificar Permiss√µes
```python
# ‚ùå Ruim
if st.button("Deletar"):
    delete_record()

# ‚úÖ Bom
if has_access_level('ADMIN'):
    if st.button("Deletar"):
        delete_record()
else:
    st.warning("Acesso negado. Apenas administradores podem deletar.")
```

### 2. Usar Mensagens Claras
```python
# ‚ùå Ruim
st.error("Acesso negado")

# ‚úÖ Bom
st.warning("‚ö†Ô∏è Voc√™ n√£o tem permiss√£o para editar dados. N√≠vel de acesso: Visualiza√ß√£o")
```

### 3. Manter Consist√™ncia
- Use sempre `has_access_level()` para verifica√ß√µes
- Mantenha mensagens de erro consistentes
- Use os mesmos n√≠veis em toda a aplica√ß√£o

### 4. Testar Cen√°rios
- Teste com usu√°rios de diferentes n√≠veis
- Verifique mensagens de erro
- Confirme que dados sens√≠veis n√£o s√£o expostos

## Conclus√£o

O sistema de autentica√ß√£o do Farol foi projetado para ser robusto, seguro e f√°cil de usar. Seguindo este guia, desenvolvedores podem facilmente integrar controles de acesso em novos m√≥dulos e manter a seguran√ßa do sistema.

Para d√∫vidas ou problemas, consulte o README.md principal ou entre em contato com a equipe de desenvolvimento.
