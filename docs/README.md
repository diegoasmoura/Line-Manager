Farol doc

# üì¶ Sistema de Gest√£o de Embarques de Algod√£o

Este sistema foi desenvolvido para organizar e rastrear embarques de algod√£o, permitindo o controle de dados de vendas, solicita√ß√µes de booking, ajustes e divis√£o de rotas. √â dividido em **stages** (etapas), cada uma com responsabilidades espec√≠ficas.

---

## üë• Equipes (Stages)

* Sales
    * Insere os embarques
    * Edita campos b√°sicos
    * Realiza ajustes simples
* Booking Management
    * Solicita bookings para os embarques
    * Realiza altera√ß√µes cr√≠ticas (critical adjustments)
    * Gerencia divis√µes de rotas (splits), que exigem valida√ß√£o posterior
* Container Delivery at Port (em desenvolvimento)
    * Etapa respons√°vel pelo controle log√≠stico at√© o porto


## üß≠ Funcionalidades dispon√≠veis ao entrar na tela

Ao entrar no m√≥dulo Shipments (com o stage Sales Data selecionado por padr√£o), o usu√°rio tem acesso √†s seguintes funcionalidades:
1. Incluir novo embarque
2. Editar embarque existente (campos b√°sicos)
3. Solicitar Booking
4. Fazer Ajustes Cr√≠ticos (Adjustments)

üìå Regras de Exibi√ß√£o dos Bot√µes "New Booking" e "Adjustments"
Na tela de Shipments, a exibi√ß√£o dos bot√µes de a√ß√£o depende do status original do embarque selecionado na coluna Farol Status:
* Bot√£o "New Booking"√â exibido somente quando o embarque selecionado possui o status original "New Request".
* Bot√£o "Adjustments"√â exibido somente quando o embarque selecionado possui qualquer status original diferente de "New Request".

	‚ö†Ô∏è Importante:	A l√≥gica de exibi√ß√£o considera sempre o valor original do status armazenado no banco de dados, mesmo que o usu√°rio tente editar o status diretamente na grade.	Isso garante que as a√ß√µes dispon√≠veis estejam alinhadas com a situa√ß√£o real do embarque, evitando inconsist√™ncias e tentativas de burlar o fluxo operacional.

---

## üß© Detalhamento das op√ß√µes

### 1. üÜï Incluir novo embarque
* Acessa via bot√£o New Shipment
* Preenche os 13 campos obrigat√≥rios
* Ao confirmar:
    * Registro salvo na tabela F_CON_SALES_DATA
    * Status padr√£o: New Request
---
### 2. ‚úèÔ∏è Editar embarque (Shipments)

* Permite editar campos habilitados diretamente na grade
* Gatilhos:
    * Se altera√ß√µes forem feitas, a grade Changes Made √© exibida
    * Ao confirmar:
        * Registro salvo na tabela F_CON_ADJUSTMENTS_LOG
        * Request Type = Basic, Status = Approved
        * Trigger √© ativada, chamando a procedure que atualiza F_CON_SALES_DATA e F_CON_BOOKING_MANAGEMENT
    * Ao descartar:
        * Altera√ß√µes s√£o desfeitas e a grade some

üìå **Restri√ß√µes de Edi√ß√£o por Stage:**
* **Campos do Sales Data**: Edit√°veis apenas no stage "Sales Data"
    * **Type of Shipment**: Somente leitura nos outros stages
    * **Sales Quantity of Containers**: Somente leitura nos outros stages
    * **Container Type**: Somente leitura nos outros stages
    * **Booking Port of Loading POL**: Somente leitura no Booking Management (dados do Sales Data)
    * **Booking Port of Delivery POD**: Somente leitura no Booking Management (dados do Sales Data)
    * **Sales Port of Loading POL**: Somente leitura no Container Delivery at Port
    * **Sales Port of Delivery POD**: Somente leitura no Container Delivery at Port
    * Isso garante integridade dos dados, pois esses campos existem originalmente na tabela Sales Data e s√£o trazidos via JOIN para os outros stages
üü° Farol Status ‚Äì Controle e restri√ß√µes
* Os seguintes status est√£o dispon√≠veis na coluna Farol Status da tela shipments.py:
    * New Request
    * Booking Requested
    * Received from Carrier
    * Booking Under Review
    * Adjustment Requested
    * Booking Approved
    * Booking Cancelled
    * Booking Rejected
* ‚ö†Ô∏è O status Adjustment Requested √© controlado exclusivamente pelo m√≥dulo booking_adjustments.py
    * N√£o deve ser alterado diretamente na tela shipments.py
    * Se o usu√°rio tentar:
        * Alterar de Adjustment Requested para qualquer outro status
        * Alterar para Adjustment Requested a partir de qualquer outro status
* ‚Üí O sistema n√£o exibir√° a grade de altera√ß√µes (Changes Made) e apresentar√° o seguinte aviso:‚ö†Ô∏è Status 'Adjustment Requested' n√£o pode ser alterado diretamente. Use o m√≥dulo de ajustes para solicitar mudan√ßas.
---

### 3. üì§ Solicitar Booking

Dispon√≠vel apenas para embarques com status New Request
Acessa via bot√£o New Booking (requer sele√ß√£o pr√©via de um embarque)
Campos obrigat√≥rios:
* Carrier
* Freight Forwarder
* Booking Request Date/Time
Ao confirmar:
* Registro √© salvo na tabela F_CON_BOOKING_MANAGEMENT
* O status do embarque na F_CON_SALES_DATA √© atualizado para Booking Requested
---

### 4. üõ†Ô∏è Ajustes Cr√≠ticos (Adjustments)

Ajustes cr√≠ticos s√£o realizados via bot√£o Adjustments, dispon√≠vel na tela principal ap√≥s a sele√ß√£o de um embarque. Essa funcionalidade foi criada para:
* Alterar campos n√£o edit√°veis diretamente na tela de Shipments
* Executar splits (divis√£o de rota, criando m√∫ltiplas linhas)

---

#### üß≠ Como funciona

O campo Split Number define o tipo de ajuste:
* 0 ‚Üí Ajuste na linha principal
* >0 ‚Üí Criar√° novas linhas com base em splits

Campos ajust√°veis incluem:
* POL, POD, Carrier, Datas e demais campos n√£o dispon√≠veis para edi√ß√£o direta na tela

Ap√≥s preenchimento da justificativa e confirma√ß√£o:
* Registro √© salvo na tabela F_CON_ADJUSTMENTS_LOG
* Request Type = Critic, Status = Pending
* O campo Farol Status √© atualizado para Adjustment Requested nas tabelas:
    * F_CON_SALES_DATA
    * F_CON_BOOKING_MANAGEMENT
* Splits ficam ocultos na tela at√© aprova√ß√£o
* Triggers e procedures n√£o s√£o acionadas neste momento


---

#### üìù Ajustes normais (sem split)

- As altera√ß√µes permanecem pendentes at√© revis√£o
- Apenas ap√≥s aprova√ß√£o na tela `Review Adjustments` √© que as mudan√ßas s√£o aplicadas nas tabelas principais F_CON_SALES_DATA
- Toda altera√ß√£o √© rastreada via:

  - Coluna alterada
  - Valor anterior e novo valor
  - Justificativa: √°rea, motivo, respons√°vel e coment√°rios opcionais

#### üîÄ Ajustes com Split

- Splits s√£o criados como **novas linhas** nas tabelas `F_CON_SALES_DATA` e `F_CON_BOOKING_MANAGEMENT`
- Estas novas linhas j√° possuem os dados ajustados informados pelo usu√°rio
- Por√©m, **s√≥ ficam vis√≠veis na interface** (`Shipments.py`) **ap√≥s aprova√ß√£o**

- Isso √© controlado por um filtro no c√≥digo:

  ```python
  df = df[
      ~(
          (df["Type of Shipment"] == "Split") & 
          (df["Farol Status"] == "Adjustment Requested")
      )
  ]

## ‚úÖ Diferen√ßa entre ajustes Basic vs Critic

| Ajuste via...                  | Request Type | Status       | Trigger?  | Justificativa?    | Aprovado autom√°tico? |
|-----------------------|---------------|-----------|----------|----------------|-------------------------|
| Shipments (edi√ß√£o)     | Basic               | Approved  | Sim         | N√£o                   | Sim                                  |
| Adjustments (cr√≠tico)   | Critic               | Pending     | N√£o        | Sim                    | N√£o (depende de valida√ß√£o posterior) |

---

## üìã Gest√£o de Aprova√ß√µes de Ajustes (Booking Adjustments)

O m√≥dulo **Booking Adjustments** (`booking_adjustments.py`) √© respons√°vel pela revis√£o e aprova√ß√£o dos ajustes cr√≠ticos solicitados atrav√©s da tela de Adjustments. Esta funcionalidade centraliza o controle de qualidade e valida√ß√£o das mudan√ßas antes que sejam efetivadas no sistema.

### üéØ Funcionalidades Principais

#### üîç **Filtros de Pesquisa**
- **Per√≠odo**: Hoje, √öltimos 7 dias, √öltimos 30 dias, Todos
- **Busca por Farol Reference**: Campo de texto para localiza√ß√£o r√°pida
- **Status**: Filtragem por status de aprova√ß√£o
- **√Årea**: Filtro por √°rea respons√°vel pelo ajuste
- **Stage**: Filtro por etapa do processo (Sales Data, Booking Management, etc.)

#### üìä **Interface Simplificada**

**Grade √önica de Adjustment Management**
- **Interface direta**: Sem abas - grade principal para agilizar aprova√ß√µes
- **Dados simulados**: Visualiza√ß√£o da `F_CON_SALES_DATA` com ajustes aplicados
- **Colunas consistentes**: Mesmas colunas da tela `shipments_split.py`
- **Edi√ß√£o in-line**: Status edit√°vel diretamente na grade via `st.data_editor`
- **Resumo visual**: Coluna "Changes Made" com altera√ß√µes aplicadas
- **Coment√°rios**: Coluna "Comments" da solicita√ß√£o original
- **Rastreabilidade**: "Adjustment ID" para controle completo
- **Tratamento de splits**: Linhas separadas para cada split de embarque

### ‚öôÔ∏è **Sistema de Aprova√ß√£o**

#### üéÆ **Controles de Status**
O sistema utiliza os status oficiais da tabela UDC (Farol Status):
- **Adjustment Requested**: Aguardando aprova√ß√£o
- **Booking Approved**: Ajuste aprovado e efetivado
- **Booking Rejected**: Ajuste rejeitado
- **Booking Cancelled**: Ajuste cancelado
- **Received from Carrier**: Recebido do transportador

#### ‚úÖ **Processo de Aprova√ß√£o**

**1. Sele√ß√£o do Status**
- Dropdown com op√ß√µes da UDC para garantir consist√™ncia
- Aplica√ß√£o do status para todos os ajustes da Farol Reference

**2. Atualiza√ß√£o em Lote**
- Um clique aprova/rejeita todos os ajustes de uma refer√™ncia
- Atualiza√ß√£o autom√°tica nas tabelas principais:
  - `F_CON_SALES_DATA`
  - `F_CON_BOOKING_MANAGEMENT`
  - `F_CON_CARGO_LOADING_CONTAINER_RELEASE`

**3. Rastreabilidade**
- Data de confirma√ß√£o registrada automaticamente
- Hist√≥rico completo na `F_CON_ADJUSTMENTS_LOG`

### üìù **Resumo de Altera√ß√µes**

Para cada Farol Reference, o sistema exibe:
- **Splits**: Novas refer√™ncias criadas com quantidades
- **Altera√ß√µes de Campos**: Formato "Campo: Valor Anterior ‚Üí Novo Valor"
- **Detalhes Individuais**: Visualiza√ß√£o opcional de cada ajuste espec√≠fico

### üîß **Controles de Interface**

- **Update Status**: Bot√£o principal para aplicar o status selecionado
- **View Details**: Exibe dados ajustados simulados (mesmas colunas da Adjusted Data View)
  - Visualiza√ß√£o principal com dados simulados finais
  - Se√ß√£o adicional com detalhes t√©cnicos dos ajustes individuais
- **Layout Responsivo**: Interface otimizada com colunas balanceadas

### ‚ö†Ô∏è **Regras Importantes**

1. **Aprova√ß√£o Unificada**: Todos os ajustes de uma Farol Reference s√£o aprovados/rejeitados em conjunto
2. **Consist√™ncia UDC**: Apenas status v√°lidos da tabela UDC s√£o utilizados
3. **Visibilidade de Splits**: Splits s√≥ ficam vis√≠veis na tela principal ap√≥s aprova√ß√£o
4. **Rastreabilidade Completa**: Todas as a√ß√µes s√£o logadas com data/hora

### üìà **M√©tricas Exibidas**

- **Total Adjustments**: N√∫mero total de ajustes no filtro atual
- **Farol References**: Quantidade de refer√™ncias √∫nicas afetadas
- **Pending Adjustments**: Ajustes aguardando aprova√ß√£o

---

## üîß Tela Principal de Adjustment Management

A **interface simplificada** foi implementada para fornecer uma **experi√™ncia direta e eficiente** de aprova√ß√£o de ajustes, mostrando uma **simula√ß√£o visual** dos dados da `F_CON_SALES_DATA` j√° com os ajustes aplicados.

### üéØ **Design Simplificado**

- **Interface √önica**: Sem abas - grade principal para agilizar o processo de aprova√ß√£o
- **Simula√ß√£o Pr√©via**: Visualiza√ß√£o dos dados j√° com ajustes aplicados
- **Estrutura Consistente**: Mesmas colunas da tela `shipments_split.py`
- **Aprova√ß√£o Direta**: Edi√ß√£o de status in-line para decis√µes r√°pidas

### üìä **Estrutura de Colunas**

A visualiza√ß√£o apresenta as **mesmas colunas da tela de split**, garantindo familiaridade ao usu√°rio:

| Coluna | Descri√ß√£o | Edit√°vel |
|--------|-----------|----------|
| **Farol Reference** | Refer√™ncia √∫nica do embarque | ‚ùå |
| **Status** | Status atual do ajuste | ‚úÖ |
| **Quantity** | Quantidade de containers (com splits aplicados) | ‚ùå |
| **POL** | Porto de Carregamento | ‚ùå |
| **POD** | Porto de Destino (com ajustes aplicados) | ‚ùå |
| **Place of Receipt** | Local de Recebimento | ‚ùå |
| **Final Destination** | Destino Final | ‚ùå |
| **Carrier** | Transportador | ‚ùå |
| **Cut-off Start** | Data de Cut-off In√≠cio | ‚ùå |
| **Cut-off End** | Data de Cut-off Fim | ‚ùå |
| **Required Arrival** | Data de Chegada Requerida | ‚ùå |
| **Changes Made** | Resumo das altera√ß√µes aplicadas | ‚ùå |
| **Comments** | Coment√°rios informados na tela shipments_split.py | ‚ùå |
| **Adjustment ID** | ID √∫nico do ajuste para rastreabilidade | ‚ùå |

### üîÑ **Processamento de Dados**

#### **1. Busca de Dados Originais**
```python
def get_original_sales_data(farol_reference):
    # Busca dados base da F_CON_SALES_DATA
    # para cada Farol Reference
```

#### **2. Aplica√ß√£o de Ajustes**
```python
def apply_adjustments_to_data(original_data, adjustments_df):
    # Aplica todos os ajustes (exceto splits) 
    # aos dados originais
```

#### **3. Tratamento de Splits**
- **Splits s√£o exibidos como linhas separadas**
- Cada split mostra a **quantidade dividida**
- Mant√©m os **dados ajustados** aplicados

#### **4. Resumo de Altera√ß√µes**
```python
def generate_changes_summary(adjustments_df, farol_ref):
    # Gera resumo no formato:
    # üîß Split: X containers
    # üìù Campo: Valor Anterior ‚Üí Novo Valor
```

### ‚ö° **Funcionalidades Interativas**

#### **üéõÔ∏è Status Edit√°vel In-Grid**
- **Edi√ß√£o direta**: Status pode ser alterado diretamente na grade
- **Dropdown limpo**: Sem op√ß√µes vazias ou inv√°lidas
- **Op√ß√µes v√°lidas**:
  - ‚úÖ **Adjustment Requested** (padr√£o)
  - ‚úÖ **Booking Approved**
  - ‚úÖ **Booking Rejected** 
  - ‚úÖ **Booking Cancelled**
  - ‚úÖ **Received from Carrier**

#### **üîÑ Detec√ß√£o de Mudan√ßas**
- Sistema detecta automaticamente altera√ß√µes no Status
- Exibe preview das mudan√ßas antes da aplica√ß√£o
- Bot√µes **Apply Changes** / **Cancel Changes** para controle total

#### **üíæ Atualiza√ß√£o em Lote**
- Aplica mudan√ßas de status em **todas as tabelas relevantes**:
  - `F_CON_SALES_DATA`
  - `F_CON_BOOKING_MANAGEMENT`
  - `F_CON_CARGO_LOADING_CONTAINER_RELEASE`
- **Transa√ß√£o at√¥mica**: Sucesso completo ou rollback total

### üìã **Informa√ß√µes Adicionais**

#### **üé® Changes Made**
- **Formato amig√°vel**: "üìù Campo: Anterior ‚Üí Novo"
- **Splits destacados**: "üîß Split: X containers"
- **M√∫ltiplas altera√ß√µes**: Separadas por " | "

#### **üí¨ Comments**
- **Contexto**: Exibe coment√°rios originais informados durante a solicita√ß√£o
- **Origem**: Dados vindos da tela `shipments_split.py`
- **Fallback**: "Nenhum coment√°rio" quando campo vazio

#### **üîç Adjustment ID**
- **Rastreabilidade**: UUID √∫nico para cada conjunto de ajustes
- **Auditoria**: Facilita localiza√ß√£o nos logs
- **Consist√™ncia**: Mesmo ID para ajustes da mesma solicita√ß√£o

### ‚öôÔ∏è **Valida√ß√µes e Robustez**

#### **üõ°Ô∏è Normaliza√ß√£o de Status**
- **M√∫ltiplas camadas** de valida√ß√£o para eliminar valores vazios
- **Status padr√£o**: "Adjustment Requested" sempre garantido
- **Fallback seguro**: Lista nunca fica vazia

#### **üîí Integridade dos Dados**
- **Somente Status edit√°vel**: Demais colunas protegidas
- **Valida√ß√£o UDC**: Apenas status v√°lidos da tabela UDC
- **Consist√™ncia temporal**: Data de confirma√ß√£o autom√°tica

### üéØ **Benef√≠cios para o Usu√°rio**

#### **üëÅÔ∏è Visualiza√ß√£o Clara**
- **Preview completo**: Ver dados finais antes da aprova√ß√£o
- **Contexto visual**: Mesma interface familiar do split
- **Compara√ß√£o f√°cil**: "Changes Made" mostra o que mudou

#### **‚ö° Efici√™ncia**
- **Aprova√ß√£o r√°pida**: Status direto na grade
- **Menos cliques**: Sem necessidade de abrir modais
- **Batch processing**: M√∫ltiplas refer√™ncias de uma vez

#### **üîê Controle Total**
- **Preview das mudan√ßas**: Ver antes de aplicar
- **Cancelamento seguro**: Voltar atr√°s se necess√°rio
- **Rastreabilidade**: Hist√≥rico completo de a√ß√µes

### üîÑ **Substitui√ß√£o da List View**

A **Adjusted Data View** substitui completamente a antiga **List View**, oferecendo:

| Funcionalidade | List View Anterior | Adjusted Data View Nova |
|---------------|-------------------|------------------------|
| **Visualiza√ß√£o** | Dados brutos da tabela | Dados simulados com ajustes |
| **Interatividade** | Apenas leitura | Status edit√°vel |
| **Contexto** | Sem informa√ß√£o de mudan√ßas | Resumo completo das altera√ß√µes |
| **Splits** | N√£o mostrava divis√µes | Exibe splits como linhas separadas |
| **Aprova√ß√£o** | Processo separado | Integrado na visualiza√ß√£o |

---

